<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Hw3MaMe Services</title>
  <link rel="stylesheet" href="../styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="../supabaseClient.js"></script>
</head>
<body>
  <nav class="navbar">
    <a href="../public_pages/index.html" class="brand">Hw3MaMe Services</a>
    <div class="nav-links">
      <a href="../public_pages/index.html">Home</a>
      <a href="../public_pages/about.html">About</a>
      <a href="../public_pages/contact.html">Contact</a>
      <a href="../public_pages/login.html">Login</a>
      <a href="../public_pages/signup.html">Sign Up</a>
      <a href="../worker_pages/worker-dashboard.html">Worker Dashboard</a>
      <a href="../owner_pages/owner-dashboard.html">Owner Dashboard</a>
      <a href="admin-dashboard.html">Admin Dashboard</a>
    </div>
  </nav>

  <main class="page">
    <h1>Admin Dashboard</h1>
    <p>Manage verifications, users, contracts, fraud detection, and support tickets.</p>

    <section class="section">
      <h2>Platform Overview</h2>
      <div class="widget-grid">
        <div class="widget-card">
          <h3>Total Users</h3>
          <p class="stat-value" id="stat-admin-users">-</p>
        </div>
        <div class="widget-card">
          <h3>Verifications Pending</h3>
          <p class="stat-value" id="stat-admin-verifications">-</p>
        </div>
        <div class="widget-card">
          <h3>Active Contracts</h3>
          <p class="stat-value" id="stat-admin-active-contracts">-</p>
        </div>
        <div class="widget-card">
          <h3>Fraud Alerts</h3>
          <p class="stat-value" id="stat-admin-fraud">-</p>
        </div>
        <div class="widget-card">
          <h3>Verification Status</h3>
          <div class="chart-container">
            <canvas id="admin-verification-chart"></canvas>
          </div>
        </div>
        <div class="widget-card">
          <h3>Contract Status</h3>
          <div class="chart-container">
            <canvas id="admin-contracts-chart"></canvas>
          </div>
        </div>
      </div>
    </section>
  </main>
  <script>
    let adminVerificationChart;
    let adminContractsChart;
    async function loadAdminDashboardData() {
      const usersEl = document.getElementById('stat-admin-users');
      const verificationsEl = document.getElementById('stat-admin-verifications');
      const activeContractsEl = document.getElementById('stat-admin-active-contracts');
      const fraudEl = document.getElementById('stat-admin-fraud');

      const [{ data: users }, { data: contracts }] = await Promise.all([
        supabaseClient.from('users').select('*'),
        supabaseClient.from('contracts').select('*')
      ]);

      const totalUsers = users ? users.length : 0;
      const pendingVerifications = (users || []).filter(u => (u.verification_level || 0) < 6).length;
      const approvedVerifications = (users || []).filter(u => (u.verification_level || 0) >= 6).length;
      const activeContracts = (contracts || []).filter(c => c.status === 'active').length;
      const completedContracts = (contracts || []).filter(c => c.status === 'completed').length;
      const terminatedContracts = (contracts || []).filter(c => c.status === 'terminated').length;
      const fraudAlerts = (contracts || []).filter(c => c.status === 'flagged_fraud').length;

      usersEl.textContent = totalUsers;
      verificationsEl.textContent = pendingVerifications;
      activeContractsEl.textContent = activeContracts;
      fraudEl.textContent = fraudAlerts;

      // Charts
      const verCtx = document.getElementById('admin-verification-chart').getContext('2d');
      const verData = [pendingVerifications, approvedVerifications];
      if (adminVerificationChart) {
        adminVerificationChart.data.datasets[0].data = verData;
        adminVerificationChart.update();
      } else {
        adminVerificationChart = new Chart(verCtx, {
          type: 'doughnut',
          data: {
            labels: ['Pending', 'Approved'],
            datasets: [{
              data: verData,
              backgroundColor: ['#fbbf24', '#22c55e']
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }

      const conCtx = document.getElementById('admin-contracts-chart').getContext('2d');
      const conData = [activeContracts, completedContracts, terminatedContracts, fraudAlerts];
      if (adminContractsChart) {
        adminContractsChart.data.datasets[0].data = conData;
        adminContractsChart.update();
      } else {
        adminContractsChart = new Chart(conCtx, {
          type: 'bar',
          data: {
            labels: ['Active', 'Completed', 'Terminated', 'Fraud'],
            datasets: [{
              data: conData,
              backgroundColor: ['#38bdf8', '#22c55e', '#6b7280', '#ef4444']
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, ticks: { precision: 0 } }
            }
          }
        });
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const user = await requireAuth('../public_pages/login.html');
      if (!user) return;

      await loadAdminDashboardData();

      supabaseClient
        .channel('admin-users')
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'users' },
          async (payload) => {
            await loadAdminDashboardData();
            const u = payload.new || payload.old;
            showToast(`User update: ${u?.email || ''} (${payload.eventType})`, 'info');
          }
        )
        .subscribe();

      supabaseClient
        .channel('admin-contracts')
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'contracts' },
          async (payload) => {
            await loadAdminDashboardData();
            const c = payload.new || payload.old;
            if (c?.status === 'flagged_fraud') {
              showToast(`Fraud alert on contract ${c.id}`, 'error');
            } else {
              showToast(`Contract ${c?.id || ''} ${payload.eventType}`, 'info');
            }
          }
        )
        .subscribe();
    });
  </script>
</body>
</html>


